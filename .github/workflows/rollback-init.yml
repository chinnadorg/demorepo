name: Real Rollback Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Choose Environment to Rollback"
        type: choice
        required: true
        options:
          - dev
          - staging
          - prod
      tag:
        description: "Tag to rollback to (ex: Release_V5)"
        required: true

permissions:
  contents: write
  packages: write

jobs:
  rollback:
    runs-on: ubuntu-latest

    outputs:
      status: ${{ steps.result.outputs.status || steps.result_error.outputs.status }}
      tag: ${{ steps.result.outputs.tag || steps.result_error.outputs.tag }}
      error: ${{ steps.result_error.outputs.error }}

    steps:
      # -----------------------------------------------------------
      # Checkout main repository
      # -----------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # -----------------------------------------------------------
      # Validate Tag Exists
      # -----------------------------------------------------------
      - name: Validate Tag
        id: validate
        run: |
          echo "Checking Tag: ${{ github.event.inputs.tag }}"
          if ! git rev-parse "refs/tags/${{ github.event.inputs.tag }}" >/dev/null 2>&1; then
            echo "Tag does not exist"
            exit 1
          fi
        shell: bash

      # -----------------------------------------------------------
      # Checkout Code of Selected Tag
      # -----------------------------------------------------------
      - name: Checkout Tagged Source
        run: |
          git checkout tags/${{ github.event.inputs.tag }}
        shell: bash

      # -----------------------------------------------------------
      # Map environment to Azure resources
      # -----------------------------------------------------------
      - name: Select Deployment Settings
        id: envmap
        run: |
          if [ "${{ github.event.inputs.environment }}" = "dev" ]; then
            echo "container=dxc-content-agent-dev" >> $GITHUB_OUTPUT
            echo "resource_group=CXO-F1" >> $GITHUB_OUTPUT
            echo "container_env=DXC-CXOF1-Demo" >> $GITHUB_OUTPUT
            echo "location=centralindia" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.inputs.environment }}" = "staging" ]; then
            echo "container=dxc-content-agent-stg" >> $GITHUB_OUTPUT
            echo "resource_group=CXO-STG" >> $GITHUB_OUTPUT
            echo "container_env=DXC-CXOF1-Staging" >> $GITHUB_OUTPUT
            echo "location=centralindia" >> $GITHUB_OUTPUT
          else
            echo "container=dxc-content-agent-prod" >> $GITHUB_OUTPUT
            echo "resource_group=CXO-PROD" >> $GITHUB_OUTPUT
            echo "container_env=DXC-CXOF1-Production" >> $GITHUB_OUTPUT
            echo "location=centralindia" >> $GITHUB_OUTPUT
          fi

      # -----------------------------------------------------------
      # Azure Login
      # -----------------------------------------------------------
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # -----------------------------------------------------------
      # Login to GHCR
      # -----------------------------------------------------------
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ secrets.GIT_USERNAME }}
          password: ${{ secrets.GIT_TOKEN }}

      # -----------------------------------------------------------
      # Build container from this tag and deploy
      # -----------------------------------------------------------
      - name: Build & Deploy Container App
        id: deploy
        uses: azure/container-apps-deploy-action@v1
        with:
          appSourcePath: ${{ github.workspace }}
          registryUrl: ghcr.io
          registryUsername: ${{ secrets.GHCR_USERNAME }}
          registryPassword: ${{ secrets.GHCR_PAT }}
          containerAppName: ${{ steps.envmap.outputs.container }}
          resourceGroup: ${{ steps.envmap.outputs.resource_group }}
          containerAppEnvironment: ${{ steps.envmap.outputs.container_env }}
          location: ${{ steps.envmap.outputs.location }}
          imageToBuild: ghcr.io/${{ secrets.GHCR_USERNAME }}/dxc-content-agent:${{ github.event.inputs.tag }}

      # -----------------------------------------------------------
      # Store success output
      # -----------------------------------------------------------
      - name: Store success output
        if: success()
        id: result
        run: |
          echo "status=success" >> $GITHUB_OUTPUT
          echo "tag=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT

      # -----------------------------------------------------------
      # Capture failure
      # -----------------------------------------------------------
      - name: Capture Error
        if: failure()
        id: result_error
        run: |
          echo "status=failure" >> $GITHUB_OUTPUT
          echo "tag=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
          echo "error=Rollback failed at deployment" >> $GITHUB_OUTPUT

  # ============================================================
  # SUCCESS EMAIL
  # ============================================================
  rollback_success_email:
    needs: rollback
    if: needs.rollback.outputs.status == 'success'
    uses: ./.github/workflows/send-mail.yml
    secrets: inherit
    with:
      subject: "ROLLBACK SUCCESS — ${{ needs.rollback.outputs.tag }}"
      message: |
        <b>Rollback Completed Successfully</b><br/>
        <b>Tag:</b> ${{ needs.rollback.outputs.tag }}<br/>
        <b>Environment:</b> ${{ github.event.inputs.environment }}<br/>
      status: success
      from: "chinnadurai.madasamy@cxontology.com"
      to: "chinnad64@gmail.com, team@company.com"

  # ============================================================
  # FAILURE EMAIL
  # ============================================================
  rollback_failure_email:
    needs: rollback
    if: needs.rollback.outputs.status == 'failure'
    uses: ./.github/workflows/send-mail.yml
    secrets: inherit
    with:
      subject: "ROLLBACK FAILED — ${{ needs.rollback.outputs.tag }}"
      message: |
        <b>Rollback Failed</b><br/>
        <b>Tag:</b> ${{ needs.rollback.outputs.tag }}<br/>
        <b>Error:</b> ${{ needs.rollback.outputs.error }}<br/>
        <b>Environment:</b> ${{ github.event.inputs.environment }}<br/>
      status: failure
      from: "chinnadurai.madasamy@cxontology.com"
      to: "chinnad64@gmail.com, team@company.com"
