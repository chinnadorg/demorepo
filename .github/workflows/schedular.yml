name: Unified Scheduler

on:
  schedule:
    - cron: "30 4 * * *"
    - cron: "30 5 * * *"
    - cron: "30 16 * * *"
    - cron: "30 17 * * *"

  workflow_dispatch:
    inputs:
      environment:
        type: choice
        required: true
        options: [dev, staging, prod]
      action:
        type: choice
        required: true
        options: [start, stop]

jobs:

  scheduler:
    runs-on: ubuntu-latest

    outputs:
      environment: ${{ steps.decide.outputs.environment }}
      action: ${{ steps.decide.outputs.action }}
      error: ${{ steps.capture_error.outputs.error }}

    steps:

      - name: Debug Inputs
        run: |
          echo "manual env='${{ github.event.inputs.environment }}'"
          echo "manual action='${{ github.event.inputs.action }}'"
          echo "schedule='${{ github.event.schedule }}'"

      ###################################################################
      # INLINE CONFIG – NO EXTERNAL FILES
      ###################################################################
      - name: Load Inline Config
        id: config
        run: |
          cat > config.yml <<EOF
          rules:
            - { environment: dev,     cron: "30 4 * * *",  action: start }
            - { environment: staging, cron: "30 5 * * *",  action: start }
            - { environment: prod,    cron: "30 4 * * *",  action: start }
            - { environment: dev,     cron: "30 16 * * *", action: stop }
            - { environment: staging, cron: "30 17 * * *", action: stop }
            - { environment: prod,    cron: "30 16 * * *", action: stop }

          apps:
            dev:
              app: "dev-container-app"
              rg:  "dev-resource-group"
            staging:
              app: "staging-container-app"
              rg:  "staging-resource-group"
            prod:
              app: "prod-container-app"
              rg:  "prod-resource-group"
          EOF

          echo "Using inline config:"
          cat config.yml

      ###################################################################
      # RULE DECISION
      ###################################################################
      - name: Determine Rule
        id: decide
        run: |
          # Manual override
          if [[ "${{ github.event.inputs.environment }}" != "" ]]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
            echo "action=${{ github.event.inputs.action }}" >> $GITHUB_OUTPUT
            exit 0
          fi

          CURRENT_CRON='${{ github.event.schedule }}'
          NORMAL=$(echo "$CURRENT_CRON" | sed 's/"//g' | xargs)

          MATCH=$(yq ".rules[] | select(.cron == \"$NORMAL\")" config.yml || true)

          ENV=$(echo "$MATCH" | yq '.environment' || true)
          ACT=$(echo "$MATCH" | yq '.action' || true)

          if [[ -z "$ENV" || "$ENV" == "null" ]]; then
            echo "::error::No cron rule matched for '$NORMAL'"
            exit 1
          fi

          echo "environment=$ENV" >> $GITHUB_OUTPUT
          echo "action=$ACT" >> $GITHUB_OUTPUT

      ###################################################################
      # MAP ENV → APP / RG (INLINE)
      ###################################################################
      - name: Map Environment
        id: map
        run: |
          ENV="${{ steps.decide.outputs.environment }}"

          APP=$(yq ".apps.${ENV}.app" config.yml)
          RG=$(yq ".apps.${ENV}.rg" config.yml)

          echo "app=$APP" >> $GITHUB_OUTPUT
          echo "rg=$RG" >> $GITHUB_OUTPUT

      ###################################################################
      # AZURE LOGIN + START/STOP
      ###################################################################
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Execute Start/Stop
        id: exec
        run: |
          ACTION="${{ steps.decide.outputs.action }}"
          APP="${{ steps.map.outputs.app }}"
          RG="${{ steps.map.outputs.rg }}"
          SUB="${{ secrets.AZURE_SUBSCRIPTION_ID }}"

          echo "Executing action='$ACTION' for app='$APP'"

          if [[ "$ACTION" == "start" ]]; then
            az rest --method post \
              --url "https://management.azure.com/subscriptions/$SUB/resourceGroups/$RG/providers/Microsoft.App/containerApps/$APP/start?api-version=2023-05-01"
          else
            az rest --method post \
              --url "https://management.azure.com/subscriptions/$SUB/resourceGroups/$RG/providers/Microsoft.App/containerApps/$APP/stop?api-version=2023-05-01"
          fi

      ###################################################################
      # CAPTURE ERRORS
      ###################################################################
      - name: Capture Error
        id: capture_error
        if: always()
        run: |
          if [[ "${{ steps.exec.outcome }}" == "failure" ]]; then
            echo "error=Action execution failed" >> $GITHUB_OUTPUT
          else
            echo "error=" >> $GITHUB_OUTPUT

  #######################################################################
  # SUCCESS EMAIL
  #######################################################################
  success_email:
    needs: scheduler
    if: success()
    uses: ./.github/workflows/send-mail.yml
    secrets: inherit
    with:
      subject: "Scheduler SUCCESS - ${{ needs.scheduler.outputs.environment }} (${{ needs.scheduler.outputs.action }})"
      message: |
        <b>Environment:</b> ${{ needs.scheduler.outputs.environment }}<br>
        <b>Action:</b> ${{ needs.scheduler.outputs.action }}<br>
        <b>Time:</b> ${{ github.event.schedule || 'Manual Dispatch' }}<br>
      status: success
      from: "chinnadurai.madasamy@cxontology.com"
      to: "chinnad64@gmail.com"

  #######################################################################
  # FAILURE EMAIL
  #######################################################################
  failure_email:
    needs: scheduler
    if: failure()
    uses: ./.github/workflows/send-mail.yml
    secrets: inherit
    with:
      subject: "Scheduler FAILURE - ${{ needs.scheduler.outputs.environment || 'unknown' }} (${{ needs.scheduler.outputs.action || 'unknown' }})"
      message: |
        <b>Error:</b> ${{ needs.scheduler.outputs.error }}<br>
      status: failure
      from: "chinnadurai.madasamy@cxontology.com"
      to: "chinnad64@gmail.com,kishorekumar.chandran@cxontology.com"
