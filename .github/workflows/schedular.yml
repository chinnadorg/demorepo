name: Unified Scheduler

on:
  schedule:
    - cron: '30 4 * * *'
    - cron: '30 5 * * *'
    - cron: '30 16 * * *'
    - cron: '30 17 * * *'

  workflow_dispatch:
    inputs:
      environment:
        type: choice
        required: true
        options: [ dev, staging, prod ]
      action:
        type: choice
        required: true
        options: [ start, stop ]

jobs:
  scheduler:
    uses: ./.github/workflows/scheduler-job.yml
    with:
      config: |
        rules:
          - environment: dev
            cron: "30 4 * * *"
            action: start
          - environment: staging
            cron: "30 5 * * *"
            action: start
          - environment: prod
            cron: "30 4 * * *"
            action: start
          - environment: dev
            cron: "30 16 * * *"
            action: stop
          - environment: staging
            cron: "30 17 * * *"
            action: stop
          - environment: prod
            cron: "30 16 * * *"
            action: stop

      apps: |
        dev:
          app: "dxc-content-agent-dev"
          rg: "CXO-F1"
        staging:
          app: "dxc-content-agent-staging"
          rg: "CXO-F1"
        prod:
          app: "dxc-content-agent-prod"
          rg: "CXO-F1"

      manual_environment: ${{ github.event.inputs.environment }}
      manual_action: ${{ github.event.inputs.action }}

    secrets:
      AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

  success_email:
    needs: scheduler
    if: success()
    uses: ./.github/workflows/send-mail.yml
    secrets: inherit
    with:
      subject: "Scheduler SUCCESS - ${{ needs.scheduler.outputs.environment }} (${{ needs.scheduler.outputs.action }})"
      message: |
        <b>Environment:</b> ${{ needs.scheduler.outputs.environment }}<br/>
        <b>Action:</b> ${{ needs.scheduler.outputs.action }}<br/>
        <b>Time:</b> ${{ github.event.schedule || 'Manual Dispatch' }}<br/><br/>
        Scheduler executed successfully.
      status: success
      from: "chinnadurai.madasamy@cxontology.com"
      to: "chinnad64@gmail.com"

  failure_email:
    needs: scheduler
    if: failure()
    uses: ./.github/workflows/send-mail.yml
    secrets: inherit
    with:
      subject: "Scheduler FAILURE - ${{ needs.scheduler.outputs.environment || 'unknown' }} (${{ needs.scheduler.outputs.action || 'unknown' }})"
      message: |
        <b>Environment:</b> ${{ needs.scheduler.outputs.environment || 'unknown' }}<br/>
        <b>Action Attempted:</b> ${{ needs.scheduler.outputs.action || 'unknown' }}<br/>
        <b>Error:</b><br/>
        <span style='color:red;'>${{ needs.scheduler.outputs.error || 'No error captured' }}</span>
      status: failure
      from: "chinnadurai.madasamy@cxontology.com"
      to: "chinnad64@gmail.com"
