name: Scheduler Job

on:
  workflow_call:
    inputs:
      config:
        required: true
        type: string
      apps:
        required: true
        type: string
      manual_environment:
        required: false
        type: string
      manual_action:
        required: false
        type: string

    secrets:
      AZURE_CREDENTIALS:
        required: true
      AZURE_SUBSCRIPTION_ID:
        required: true

jobs:
  run_scheduler:   # <<< IMPORTANT FIX
    runs-on: ubuntu-latest

    outputs:
      environment: ${{ steps.decide.outputs.environment }}
      action: ${{ steps.decide.outputs.action }}
      error: ${{ steps.capture_error.outputs.error }}

    steps:

      - name: DEBUG â€” Show Incoming Inputs
        run: |
          echo "manual_environment='${{ inputs.manual_environment }}'"
          echo "manual_action='${{ inputs.manual_action }}'"
          echo "schedule='${{ github.event.schedule }}'"
          echo "event_name='${{ github.event_name }}'"

      - name: Parse Config
        id: parse
        run: |
          echo "${{ inputs.config }}" > config.yml
          echo "${{ inputs.apps }}" > apps.yml
          echo "===== CONFIG FILE ====="
          cat config.yml
          echo "===== APPS FILE ====="
          cat apps.yml

      - name: Determine Rule (manual override or cron)
        id: decide
        run: |
          echo "Step: DECIDE"

          # 1) Manual override via direct workflow inputs
          if [[ "${{ inputs.manual_environment }}" != "" && "${{ inputs.manual_environment }}" != "null" ]]; then
            echo "Manual override detected (caller inputs)."
            echo "environment=${{ inputs.manual_environment }}" >> $GITHUB_OUTPUT
            echo "action=${{ inputs.manual_action }}" >> $GITHUB_OUTPUT
            exit 0
          fi

          # 2) Manual override via github.event.inputs (defensive)
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            if [[ "${{ github.event.inputs.environment }}" != "" && "${{ github.event.inputs.environment }}" != "null" ]]; then
              echo "Manual override detected (github.event.inputs)."
              echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
              echo "action=${{ github.event.inputs.action }}" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi

          # 3) Cron-based execution
          CURRENT_CRON="${{ github.event.schedule }}"
          echo "CURRENT_CRON='$CURRENT_CRON'"

          if [[ -z "$CURRENT_CRON" ]]; then
            echo "::warning::No schedule found. Manual run without inputs."
            echo "::error::No matching cron rule found for empty schedule."
            exit 1
          fi

          MATCH=$(yq '.rules[] | select(.cron == "'$CURRENT_CRON'")' config.yml || true)

          echo "MATCHED RULE:"
          echo "$MATCH"

          ENV=$(echo "$MATCH" | yq '.environment' || true)
          ACT=$(echo "$MATCH" | yq '.action' || true)

          echo "ENV='$ENV', ACT='$ACT'"

          if [[ -z "$ENV" || "$ENV" == "null" ]]; then
            echo "::error::No matching cron rule found for cron: $CURRENT_CRON"
            exit 1
          fi

          echo "environment=$ENV" >> $GITHUB_OUTPUT
          echo "action=$ACT" >> $GITHUB_OUTPUT

      - name: Map Environment
        id: map
        run: |
          echo "Step: MAP"
          ENV="${{ steps.decide.outputs.environment }}"
          echo "ENV='$ENV'"

          APP=$(yq ".${ENV}.app" apps.yml)
          RG=$(yq ".${ENV}.rg" apps.yml)

          echo "APP='$APP', RG='$RG'"

          if [[ -z "$APP" || "$APP" == "null" ]]; then
            echo "::error::Invalid environment mapping: $ENV"
            exit 1
          fi

          echo "app=$APP" >> $GITHUB_OUTPUT
          echo "rg=$RG" >> $GITHUB_OUTPUT

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Execute Start/Stop
        id: exec
        run: |
          echo "Step: EXECUTE"

          ACTION="${{ steps.decide.outputs.action }}"
          APP="${{ steps.map.outputs.app }}"
          RG="${{ steps.map.outputs.rg }}"
          SUB="${{ secrets.AZURE_SUBSCRIPTION_ID }}"

          echo "ACTION='$ACTION'"
          echo "APP='$APP'"
          echo "RG='$RG'"
          echo "SUB='$SUB'"

          if [[ "$ACTION" == "start" ]]; then
            az rest --method post \
              --url "https://management.azure.com/subscriptions/$SUB/resourceGroups/$RG/providers/Microsoft.App/containerApps/$APP/start?api-version=2023-05-01"
          else
            az rest --method post \
              --url "https://management.azure.com/subscriptions/$SUB/resourceGroups/$RG/providers/Microsoft.App/containerApps/$APP/stop?api-version=2023-05-01"
          fi

      - name: Capture Error
        id: capture_error
        if: always()
        run: |
          echo "Step: CAPTURE ERROR"

          DECIDE_OUTCOME="${{ steps.decide.outcome }}"
          EXEC_OUTCOME="${{ steps.exec.outcome }}"

          ENV="${{ steps.decide.outputs.environment }}"
          ACT="${{ steps.decide.outputs.action }}"

          echo "DECIDE_OUTCOME='$DECIDE_OUTCOME'"
          echo "EXEC_OUTCOME='$EXEC_OUTCOME'"

          if [[ "$DECIDE_OUTCOME" == "failure" ]]; then
            echo "error=Decision step failed (env=$ENV, action=$ACT)" >> $GITHUB_OUTPUT
            exit 0
          fi

          if [[ "$EXEC_OUTCOME" == "failure" ]]; then
            echo "error=Execute step failed (env=$ENV, action=$ACT)" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "error=" >> $GITHUB_OUTPUT
          echo "No errors. Job succeeded."