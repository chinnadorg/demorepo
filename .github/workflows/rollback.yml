name: Rollback to Release Tag

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to Rollback To (example: Release_V2)"
        required: true
        type: string

permissions:
  contents: write
  packages: read

jobs:
  rollback:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Show selected tag
        env:
          SELECTED_TAG: ${{ github.event.inputs.tag }}
        run: |
          echo "Selected Tag: $SELECTED_TAG"

      - name: Validate tag exists
        env:
          SELECTED_TAG: ${{ github.event.inputs.tag }}
        run: |
          REPO_URL="${{ github.repositoryUrl }}"
          echo "Checking if tag '$SELECTED_TAG' exists on $REPO_URL"

          if ! git ls-remote --tags "$REPO_URL" | grep -q "refs/tags/$SELECTED_TAG"; then
            echo "Tag does not exist: $SELECTED_TAG"
            exit 1
          fi

          echo "Tag found!"

      - name: Deploy image for rollback
        env:
          SELECTED_TAG: ${{ github.event.inputs.tag }}
        run: |
          IMAGE="ghcr.io/chinnadorg/dxc-content-agent:$SELECTED_TAG"
          echo "Rolling back to image: $IMAGE"

          # Real Deployment Command:
          # az containerapp update \
          #   --name ${{ secrets.AZURE_APP }} \
          #   --resource-group ${{ secrets.AZURE_RG }} \
          #   --image $IMAGE

          echo "Rollback command executed (placeholder)."

      - name: Rollback success message
        run: echo "Rollback completed using tag: ${{ github.event.inputs.tag }}"