name: Rollback to Release Tag

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to Rollback To (example: Release_V2)"
        required: true
        type: string

permissions:
  contents: write
  packages: read

jobs:
  rollback:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate selected tag
        env:
          TAG: ${{ github.event.inputs.tag }}
          REPO: ${{ github.repository }}
        run: |
          REPO_URL="https://github.com/$REPO.git"

          echo "Checking if tag '$TAG' exists on $REPO_URL"

          if ! git ls-remote --tags "$REPO_URL" | grep -q "refs/tags/$TAG"; then
            echo "Tag does not exist: $TAG"
            exit 1
          fi

          echo "Tag found!"

      - name: Deploy the rollback image
        env:
          TAG: ${{ github.event.inputs.tag }}
        run: |
          IMAGE="ghcr.io/chinnadorg/dxc-content-agent:$TAG"
          echo "Rolling back to $IMAGE"
          echo "Rollback command would run here"

      - name: Mark this tag as Stable Release
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const tag = process.env.TAG;

            // Check if release already exists for this tag
            let release;
            try {
              release = await github.rest.repos.getReleaseByTag({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag: tag
              });

              // Update existing release
              await github.rest.repos.updateRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                release_id: release.data.id,
                tag_name: tag,
                name: `Stable - ${tag}`,
                draft: false,
                prerelease: false
              });

              core.info(`Updated existing release for ${tag}`);

            } catch (err) {
              // Create new release if not found
              await github.rest.repos.createRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag_name: tag,
                name: `Stable - ${tag}`,
                draft: false,
                prerelease: false
              });

              core.info(`Created new release for ${tag}`);
            }
        env:
          TAG: ${{ github.event.inputs.tag }}

